name: Deploy Database Migrations

# Trigger when:
# 1. Code is pushed to main branch
# 2. Migration files have changed
on:
  push:
    branches:
      - main
    paths:
      - 'supabase/migrations/**'

jobs:
  deploy-migrations:
    name: Apply Migrations to Production
    runs-on: ubuntu-latest

    steps:
      # Step 1: Get the code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Install Supabase CLI
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      # Step 3: Apply migrations to production
      - name: Push migrations to production
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_PROD_DB_URL }}
        run: |
          echo "üöÄ Applying migrations to production..."
          supabase db push --db-url "$SUPABASE_DB_URL"
          echo "‚úÖ Migrations applied successfully!"

      # Step 4: Notify on failure (optional)
      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Migration failed! Check logs above."
          # Add Slack/Discord notification here if desired

  # Optional: Test migrations in staging first
  test-migrations:
    name: Test Migrations in Staging
    runs-on: ubuntu-latest
    if: github.ref != 'refs/heads/main'  # Only run on PR branches

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1

      - name: Test migrations on staging
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_STAGING_DB_URL }}
        run: |
          echo "üß™ Testing migrations on staging..."
          supabase db push --db-url "$SUPABASE_DB_URL"
          echo "‚úÖ Staging test passed!"
